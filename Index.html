<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥æœ¬æ»‘é›ªä¼ - è¡Œç¨‹è¡¨ (å¯é›¢ç·š/éœæ…‹éƒ¨ç½²)</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Inter å­—é«” -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', 'Microsoft JhengHei', 'å¾®è»Ÿæ­£é»‘é«”', sans-serif;
            /* æ»‘é›ªä¸»é¡ŒèƒŒæ™¯ï¼šé›ªå±±å’Œå†°è—è‰² */
            background-color: #f0f8ff; /* AliceBlue - æ·ºé›ªç™½ */
            background-image: linear-gradient(135deg, #f0f8ff 0%, #e0f7fa 50%, #b3e5fc 100%); /* æ·ºè—åˆ°æ·±è—æ¼¸è®Š */
            min-height: 100vh;
        }
        /* ä¸»å®¹å™¨æ¨£å¼ - ç¢ºä¿åœ¨æ‰‹æ©Ÿä¸Šå…¨å¯¬ä¸¦ç½®ä¸­ */
        #app-container {
            max-width: 100%;
            padding-bottom: 80px; /* çµ¦åº•éƒ¨æŒ‰éˆ•ç•™å‡ºç©ºé–“ */
        }
        /* è¡¨æ ¼å–®å…ƒæ ¼ç·¨è¼¯æ¨¡å¼æ¨£å¼ */
        .editable:focus {
            outline: none;
            box-shadow: 0 0 0 2px #81d4fa; /* Icy blue focus ring */
            background-color: #ffffff;
        }
        /* å›ºå®šåº•éƒ¨æŒ‰éˆ•æ¬„ */
        .fixed-bottom {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 10;
            background-color: rgba(255, 255, 255, 0.95); /* åŠé€æ˜ç™½åº• */
            backdrop-filter: blur(5px);
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>

<div id="app-container" class="p-4 mx-auto md:max-w-4xl">
    <!-- Header -->
    <header class="text-center py-6 bg-white bg-opacity-80 rounded-xl shadow-xl mb-6">
        <h1 class="text-3xl font-extrabold text-sky-800 tracking-wider">
            â„ï¸ æ—¥æœ¬æ»‘é›ªè¡Œç¨‹ â„ï¸
        </h1>
        <p class="text-sm text-slate-600 mt-1">é»æ“Šè¡¨æ ¼å–®å…ƒæ ¼å³å¯ç·¨è¼¯ (è³‡æ–™å„²å­˜åœ¨æœ¬æ©Ÿç€è¦½å™¨)</p>
    </header>

    <!-- ä¸»è¡¨æ ¼å€åŸŸ -->
    <div id="schedule-table-container" class="overflow-x-auto rounded-xl shadow-2xl">
        <!-- è¡¨æ ¼å°‡ç”± JavaScript æ¸²æŸ“ -->
    </div>

    <!-- è¼‰å…¥å’ŒéŒ¯èª¤è¨Šæ¯ -->
    <div id="loading" class="text-center p-8 text-sky-700 font-bold hidden">
        è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™...
    </div>
    <div id="error-message" class="text-center p-4 bg-red-100 text-red-700 font-medium rounded-lg mt-4 hidden">
        ç™¼ç”ŸéŒ¯èª¤ï¼
    </div>

    <!-- æ¨¡æ…‹è¦–çª—ç”¨æ–¼æç¤º/ç¢ºèª (å–ä»£ alert/confirm) -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm">
            <h3 id="modal-title" class="text-xl font-bold mb-4 text-slate-800"></h3>
            <p id="modal-message" class="text-slate-600 mb-6"></p>
            <div id="modal-actions" class="flex justify-end space-x-3">
                <!-- Actions will be added by JS -->
            </div>
        </div>
    </div>
</div>

<!-- å›ºå®šåº•éƒ¨æŒ‰éˆ•æ¬„ -->
<div class="fixed-bottom p-3">
    <div class="flex flex-wrap justify-center gap-3 md:gap-6 mx-auto md:max-w-4xl">
        <button id="addRowBtn" class="flex-1 min-w-[120px] bg-sky-600 hover:bg-sky-700 text-white font-semibold py-3 px-4 rounded-full transition duration-300 shadow-lg shadow-sky-500/50">
            + å¢åŠ æ™‚é–“æ®µ
        </button>
        <button id="addColumnBtn" class="flex-1 min-w-[120px] bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-3 px-4 rounded-full transition duration-300 shadow-lg shadow-emerald-500/50">
            + å¢åŠ æ—¥æœŸ
        </button>
    </div>
</div>

<script>
    // LocalStorage Key
    const STORAGE_KEY = 'skiScheduleData';
    let scheduleData = { headers: [], schedule: [] }; // Local state for schedule

    // UI elements
    const tableContainer = document.getElementById('schedule-table-container');
    const loadingEl = document.getElementById('loading');
    const errorEl = document.getElementById('error-message');
    const addRowBtn = document.getElementById('addRowBtn');
    const addColumnBtn = document.getElementById('addColumnBtn');
    const modalEl = document.getElementById('modal');
    const modalTitleEl = document.getElementById('modal-title');
    const modalMessageEl = document.getElementById('modal-message');
    const modalActionsEl = document.getElementById('modal-actions');

    // åˆå§‹æ•¸æ“š (ä¾†è‡ªæ‚¨ä¸Šå‚³çš„ CSV æª”æ¡ˆ)
    const dateHeaders = ["12/13(äº”)", "12/14(å…­)", "12/15(æ—¥)", "12/16(ä¸€)", "12/17(äºŒ)", "12/18(ä¸‰)", "12/19(å››)", "12/20(äº”)", "12/21(å…­)"];
    const initialSchedule = [
        { Time: "6:00 - 10:00", "12/13(äº”)": "æ­é£›æ©Ÿ", "12/14(å…­)": "æ»‘é›ª", "12/15(æ—¥)": "æ»‘é›ª", "12/16(ä¸€)": "æ»‘é›ª", "12/17(äºŒ)": "æ»‘é›ª", "12/18(ä¸‰)": "å‡ºä¼èµ°èµ°(é–‹è»Š?)", "12/19(å››)": "å‡ºä¼èµ°èµ°(é–‹è»Š?)", "12/20(äº”)": "å‡ºä¼èµ°èµ°(é–‹è»Š?)", "12/21(å…­)": "Go Home ğŸ¥º", Notes: "æ»‘é›ªæ¥é§+çºœè»Šè¨‚å–®" },
        { Time: "10:00 - 12:00", "12/13(äº”)": "æ­é£›æ©Ÿ", "12/14(å…­)": "", "12/15(æ—¥)": "", "12/16(ä¸€)": "", "12/17(äºŒ)": "", "12/18(ä¸‰)": "", "12/19(å››)": "", "12/20(äº”)": "", "12/21(å…­)": "", Notes: "Judy's æ—…éŠ" },
        { Time: "12:00 - 14:00 åˆé¤", "12/13(äº”)": "é£›æ©Ÿé¤(?)", "12/14(å…­)": "é›ªå ´è™•ç†", "12/15(æ—¥)": "é›ªå ´è™•ç†", "12/16(ä¸€)": "é›ªå ´è™•ç†", "12/17(äºŒ)": "é›ªå ´è™•ç†", "12/18(ä¸‰)": "å’Œç‰›", "12/19(å››)": "åƒå•¥", "12/20(äº”)": "åƒå•¥", "12/21(å…­)": "", Notes: "è»Šè»Š 794270895" },
        { Time: "14:00 - 16:00", "12/13(äº”)": "å»æœ­å¹Œ Check in åƒé£¯", "12/14(å…­)": "æ»‘é›ª", "12/15(æ—¥)": "æ»‘é›ª", "12/16(ä¸€)": "æ»‘é›ª", "12/17(äºŒ)": "æ»‘é›ª", "12/18(ä¸‰)": "pending", "12/19(å››)": "pending", "12/20(äº”)": "pending", "12/21(å…­)": "", Notes: "ç§Ÿè»Šéœ€çŸ¥&Know how" },
        { Time: "16:00 - 18:00", "12/13(äº”)": "", "12/14(å…­)": "æ»‘é›ª", "12/15(æ—¥)": "æ»‘é›ª", "12/16(ä¸€)": "æ»‘é›ª", "12/17(äºŒ)": "æ»‘é›ª", "12/18(ä¸‰)": "pending", "12/19(å››)": "pending", "12/20(äº”)": "pending", "12/21(å…­)": "", Notes: "ç§Ÿè»Šéœ€çŸ¥&Know how" },
        { Time: "18:00 - 20:00", "12/13(äº”)": "", "12/14(å…­)": "æ»‘é›ª", "12/15(æ—¥)": "æ»‘é›ª", "12/16(ä¸€)": "æ»‘é›ª", "12/17(äºŒ)": "æ»‘é›ª", "12/18(ä¸‰)": "pending", "12/19(å››)": "pending", "12/20(äº”)": "pending", "12/21(å…­)": "", Notes: "eSIM" },
        { Time: "20:00 - 24:00", "12/13(äº”)": "", "12/14(å…­)": "ç´¯ç´¯", "12/15(æ—¥)": "ç´¯ç´¯", "12/16(ä¸€)": "ç´¯ç´¯", "12/17(äºŒ)": "ç´¯ç´¯", "12/18(ä¸‰)": "pending", "12/19(å››)": "pending", "12/20(äº”)": "pending", "12/21(å…­)": "", Notes: "ä½å®¿" },
    ];

    /**
     * é¡¯ç¤ºè‡ªå®šç¾©æ¨¡æ…‹è¦–çª—
     * @param {string} title æ¨™é¡Œ
     * @param {string} message è¨Šæ¯å…§å®¹æˆ–HTML
     * @param {Array<{label: string, style: string, action: function}>} buttons æŒ‰éˆ•é…ç½®
     */
    function showModal(title, message, buttons) {
        modalTitleEl.textContent = title;
        // å…è¨±å‚³å…¥ HTML è®“æ–°å¢æ—¥æœŸæ™‚å¯ä»¥æ”¾è¼¸å…¥æ¡†
        modalMessageEl.innerHTML = message;
        modalActionsEl.innerHTML = '';

        buttons.forEach(btnConfig => {
            const button = document.createElement('button');
            button.textContent = btnConfig.label;
            button.className = `py-2 px-4 rounded-lg font-semibold transition duration-200 ${btnConfig.style}`;
            button.onclick = () => {
                hideModal();
                btnConfig.action();
            };
            modalActionsEl.appendChild(button);
        });

        modalEl.classList.remove('hidden');
    }

    // éš±è—æ¨¡æ…‹è¦–çª—
    function hideModal() {
        modalEl.classList.add('hidden');
    }

    // --- LocalStorage Persistence ---

    /**
     * å¾ LocalStorage è¼‰å…¥è¡Œç¨‹æ•¸æ“šï¼Œè‹¥ç„¡å‰‡ä½¿ç”¨åˆå§‹æ•¸æ“šã€‚
     */
    function loadScheduleData() {
        try {
            const savedData = localStorage.getItem(STORAGE_KEY);
            if (savedData) {
                scheduleData = JSON.parse(savedData);
                console.log("Data loaded from LocalStorage.");
            } else {
                // Initializing with CSV data structure
                scheduleData.headers = ["æ™‚é–“"].concat(dateHeaders).concat(["å‚™è¨»", "é€£çµ"]);
                scheduleData.schedule = initialSchedule.map(row => {
                    // Create a clean object from the initial row data
                    const newRow = { Time: row.Time };
                    scheduleData.headers.slice(1).forEach(header => {
                        // Attempt to map headers, defaulting to an empty string if not found
                        const value = row[header] !== undefined ? row[header] : 
                                       row[header.replace('å‚™è¨»', 'Notes')] !== undefined ? row[header.replace('å‚™è¨»', 'Notes')] : 
                                       row[header.replace('é€£çµ', 'URL')] !== undefined ? row[header.replace('é€£çµ', 'URL')] : '';
                        newRow[header] = value;
                    });
                    return newRow;
                });
                saveScheduleData(); // Save initial data immediately
                console.log("No saved data found. Initializing with default data.");
            }
        } catch (e) {
            console.error("Failed to load data from LocalStorage:", e);
            errorEl.textContent = "è¼‰å…¥æ•¸æ“šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨è¨­å®šã€‚";
            errorEl.classList.remove('hidden');
        }

        renderSchedule();
        loadingEl.classList.add('hidden');
    }

    /**
     * å°‡ç•¶å‰è¡Œç¨‹æ•¸æ“šå„²å­˜åˆ° LocalStorage
     */
    function saveScheduleData() {
        try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(scheduleData));
            // console.log("Schedule data saved successfully to LocalStorage.");
        } catch (e) {
            console.error("Failed to save data to LocalStorage:", e);
            errorEl.textContent = "æ•¸æ“šå„²å­˜å¤±æ•—ï¼Œå¯èƒ½è¶…éå„²å­˜é™åˆ¶ã€‚";
            errorEl.classList.remove('hidden');
        }
    }

    /**
     * æ¸²æŸ“è¡Œç¨‹è¡¨æ ¼
     */
    function renderSchedule() {
        if (!scheduleData.headers || !scheduleData.headers.length) {
            tableContainer.innerHTML = '<p class="text-center p-4 text-slate-500">æ²’æœ‰è¡Œç¨‹æ•¸æ“šã€‚</p>';
            return;
        }

        const headers = scheduleData.headers;
        const schedule = scheduleData.schedule;
        let html = `
            <table class="w-full text-sm text-left text-slate-900 border-collapse">
                <thead class="text-xs uppercase text-white bg-sky-700 sticky top-0">
                    <tr>
                        ${headers.map(header => `
                            <th scope="col" class="py-3 px-2 md:px-4 text-center font-bold whitespace-nowrap border-b border-sky-600">
                                ${header}
                            </th>
                        `).join('')}
                    </tr>
                </thead>
                <tbody>
        `;

        schedule.forEach((row, rowIndex) => {
            html += `
                <tr class="bg-white border-b border-slate-200 hover:bg-sky-50 transition duration-150">
            `;
            headers.forEach((header, colIndex) => {
                const isTimeColumn = colIndex === 0;
                const cellValue = row[header] || '';

                // Handle 'é€£çµ' column for rendering as link
                let displayValue = cellValue;
                if (header === 'é€£çµ' && cellValue.startsWith('http')) {
                    // åªé¡¯ç¤ºå‰20å€‹å­—å…ƒï¼Œé˜²æ­¢ç¶²å€éé•·ç ´å£æ’ç‰ˆ
                    const displayText = cellValue.length > 20 ? `${cellValue.substring(0, 20)}...` : cellValue;
                    displayValue = `<a href="${cellValue}" target="_blank" class="text-sky-600 hover:text-sky-800 underline break-words">${displayText}</a>`;
                }


                html += `
                    <td class="py-2 px-2 md:px-4 text-center border border-slate-100 ${isTimeColumn ? 'font-bold bg-sky-50 sticky left-0 z-0 whitespace-nowrap' : 'editable'}"
                        data-row-index="${rowIndex}"
                        data-header="${header}"
                        ${isTimeColumn ? '' : 'contenteditable="true"'}>
                        ${displayValue}
                    </td>
                `;
            });
            html += `</tr>`;
        });

        html += `
                </tbody>
            </table>
        `;
        tableContainer.innerHTML = html;
        attachEditListeners();
    }

    /**
     * ç‚ºå¯ç·¨è¼¯çš„å–®å…ƒæ ¼é™„åŠ äº‹ä»¶ç›£è½å™¨
     */
    function attachEditListeners() {
        document.querySelectorAll('.editable[contenteditable="true"]').forEach(cell => {
            // Remove old listeners to prevent duplication
            cell.removeEventListener('blur', handleCellEdit);
            
            // Add new listener
            cell.addEventListener('blur', handleCellEdit);
        });
    }

    /**
     * è™•ç†å–®å…ƒæ ¼ç·¨è¼¯äº‹ä»¶
     * @param {Event} event 
     */
    function handleCellEdit(event) {
        const cell = event.target;
        const rowIndex = parseInt(cell.dataset.rowIndex);
        const header = cell.dataset.header;
        // ä½¿ç”¨ textContent ç¢ºä¿å–å¾—ç·¨è¼¯å¾Œçš„æ‰€æœ‰æ–‡æœ¬
        const finalValue = cell.textContent.trim();

        if (scheduleData.schedule[rowIndex] && scheduleData.schedule[rowIndex][header] !== finalValue) {
            scheduleData.schedule[rowIndex][header] = finalValue;
            saveScheduleData();
            
            // å¦‚æœæ˜¯é€£çµæ¬„ä½ï¼Œé‡æ–°æ¸²æŸ“ä»¥ç¢ºä¿æ–°è¼¸å…¥çš„ç¶²å€èƒ½è½‰æ›æˆå¯é»æ“Šçš„ <a> æ¨™ç±¤
            if (header === 'é€£çµ') {
                renderSchedule(); 
            }
        }
    }

    /**
     * å¢åŠ æ–°çš„æ™‚é–“æ®µ (è¡Œ)
     */
    addRowBtn.addEventListener('click', () => {
        showModal(
            'æ–°å¢æ™‚é–“æ®µ',
            `
            <p class="text-slate-600 mb-4">è«‹è¼¸å…¥æ–°çš„æ™‚é–“æ®µ (ä¾‹å¦‚: 24:00 - 02:00)</p>
            <input type="text" id="modal-input-row" placeholder="æ–°çš„æ™‚é–“æ®µ" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-400 focus:border-sky-400">
            `,
            [
                {
                    label: 'å–æ¶ˆ',
                    style: 'bg-slate-300 hover:bg-slate-400 text-slate-800',
                    action: () => {}
                },
                {
                    label: 'æ–°å¢',
                    style: 'bg-sky-600 hover:bg-sky-700 text-white',
                    action: () => {
                        const newTime = document.getElementById('modal-input-row').value.trim();
                        if (newTime) {
                            const newRow = { Time: newTime };
                            // ç‚ºæ‰€æœ‰æ¬„ä½åˆå§‹åŒ–ç©ºå­—ä¸²
                            scheduleData.headers.slice(1).forEach(header => {
                                newRow[header] = '';
                            });
                            scheduleData.schedule.push(newRow);
                            saveScheduleData();
                            renderSchedule();
                        }
                    }
                }
            ]
        );
        setTimeout(() => document.getElementById('modal-input-row').focus(), 100);
    });

    /**
     * å¢åŠ æ–°çš„æ—¥æœŸ (åˆ—)
     */
    addColumnBtn.addEventListener('click', () => {
        showModal(
            'æ–°å¢æ—¥æœŸ',
            `
            <p class="text-slate-600 mb-4">è«‹è¼¸å…¥æ–°çš„æ—¥æœŸ/åˆ—æ¨™é¡Œ (ä¾‹å¦‚: 12/22(æ—¥))</p>
            <input type="text" id="modal-input-col" placeholder="æ–°çš„åˆ—æ¨™é¡Œ" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-400 focus:border-sky-400">
            `,
            [
                {
                    label: 'å–æ¶ˆ',
                    style: 'bg-slate-300 hover:bg-slate-400 text-slate-800',
                    action: () => {}
                },
                {
                    label: 'æ–°å¢',
                    style: 'bg-emerald-600 hover:bg-emerald-700 text-white',
                    action: () => {
                        const newHeader = document.getElementById('modal-input-col').value.trim();
                        if (newHeader && !scheduleData.headers.includes(newHeader)) {
                            // æ’å…¥åˆ°å€’æ•¸ç¬¬ä¸‰å€‹ (åœ¨å‚™è¨»å’Œé€£çµå‰)
                            const insertIndex = scheduleData.headers.length - 2; 
                            scheduleData.headers.splice(insertIndex, 0, newHeader);
                            
                            // æ›´æ–°æ‰€æœ‰ç¾æœ‰è¡Œ
                            scheduleData.schedule.forEach(row => {
                                row[newHeader] = ''; 
                            });

                            saveScheduleData();
                            renderSchedule();

                        } else if (newHeader) {
                            showModal('éŒ¯èª¤', 'è©²æ—¥æœŸæ¨™é¡Œå·²å­˜åœ¨æˆ–ç„¡æ•ˆï¼', [{ label: 'é—œé–‰', style: 'bg-red-500 hover:bg-red-600 text-white', action: () => {} }]);
                        }
                    }
                }
            ]
        );
        setTimeout(() => document.getElementById('modal-input-col').focus(), 100);
    });


    // --- Application Entry Point ---
    window.onload = loadScheduleData;
</script>

</body>
</html>
